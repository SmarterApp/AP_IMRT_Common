package org.opentestsystem.ap.imrt.common.repository;

import com.google.common.collect.Sets;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.ap.imrt.common.builder.ImrtItemBuilder;
import org.opentestsystem.ap.imrt.common.model.Form;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.transaction.annotation.Transactional;

import static org.assertj.core.api.Assertions.assertThat;

@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
public class FormRepositoryIntegrationTest {
    @Autowired
    private ImrtItemRepository imrtItemRepository;

    @Autowired
    private FormRepository formRepository;

    @Test
    public void shouldDeleteAllFormsByItem() {
        final ImrtItem imrtItem = ImrtItemBuilder.builder()
                .build();

        Form form = new Form();
        form.setFormId("SomeId");
        form.setUpdatedBy("updatedBy");
        form.setItem(imrtItem);

        imrtItem.setForms(Sets.newHashSet(form));

        assertThat(imrtItem).isEqualTo(imrtItemRepository.save(imrtItem));

        final ImrtItem savedItem = imrtItemRepository.findById(imrtItem.getId());

        assertThat(savedItem).isNotNull();
        assertThat(savedItem.getForms()).hasSize(1);

        formRepository.deleteAllByItem(savedItem);
    }
}
